<style scoped>
  @font-face {
    font-family: "custom-font";
    src: url('//at.alicdn.com/t/font_910489_bwaqngxu2ld.eot?t=1541678703661'); /* IE9*/
    src: url('//at.alicdn.com/t/font_910489_bwaqngxu2ld.eot?t=1541678703661#iefix') format('embedded-opentype'), /* IE6-IE8 */ url('data:application/x-font-woff;charset=utf-8;base64,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') format('woff'),
    url('//at.alicdn.com/t/font_910489_bwaqngxu2ld.ttf?t=1541678703661') format('truetype'), /* chrome, firefox, opera, Safari, Android, iOS 4.2+*/ url('//at.alicdn.com/t/font_910489_bwaqngxu2ld.svg?t=1541678703661#iconfont') format('svg'); /* iOS 4.1- */
  }

  .i-icon {
    display: inline-block;
    font-family: 'custom-font' !important;
    speak: none;
    font-style: normal;
    font-weight: normal;
    font-variant: normal;
    text-transform: none;
    text-rendering: auto;
    line-height: 1;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    vertical-align: middle;
  }

  .icon-sql:before {
    content: "\e763";
  }

  .icon-SQL:before {
    content: "\e68c";
  }

  .icon-file-SQL:before {
    content: "\e7c5";
  }

</style>


<template>
  <div>

    <Row>
      <Card>
        <Icon type="md-list" size="18"/>
        与我相关的上线单 <span style="float: right">共 {{ total }} 条 &nbsp;&nbsp;</span>
        <Divider style="margin: 15px 0"/>
        <Table ref="myTable" border :columns="table_header" :data="table_content">

          <template slot="dev_team_render" slot-scope="props">
            <Tag v-for="item in props.dev_team" :key="item" color="default">
              {{item.split('-')[item.split('-').length-1]}}
            </Tag>
          </template>

          <template slot="title_render" slot-scope="props">
            <router-link :to="{name: 'flow_online_detail', params: {id: props.id}}">【{{props.system}}】{{props.title}}
            </router-link>
          </template>

          <template slot="users_render" slot-scope="props">
            <p>
            <span>产品：</span>
            <span align="center" v-for="(user, index) in props.product_users" :key="user+index">
              <span v-if="user == realname" style="font-weight:bold">{{user}} &nbsp;&nbsp; </span>
              <span v-else>{{user}}&nbsp;&nbsp;</span>
            </span>
            </p>
            <p>
            <span>开发：</span>
            <span align="center" v-for="(user, index) in props.dev_users" :key="user+index">
              <span v-if="user == realname" style="font-weight:bold">{{user}} &nbsp;&nbsp; </span>
              <span v-else>{{user}}&nbsp;&nbsp;</span>
            </span>
            </p>
            <p>
            <span>测试：</span>
            <span align="center" v-for="(user, index) in props.test_users" :key="user+index">
              <span v-if="user == realname" style="font-weight:bold">{{user}} &nbsp;&nbsp; </span>
              <span v-else>{{user}}&nbsp;&nbsp;</span>
            </span>
            </p>
            <p>
            <span>相关人员：</span>
            <span align="center" v-for="(user, index) in props.users" :key="user+index">
              <span v-if="user == realname" style="font-weight:bold">{{user}} &nbsp;&nbsp; </span>
              <span v-else>{{user}}&nbsp;&nbsp;</span>
            </span>
            </p>

          </template>

          <template slot="status_render" slot-scope="props">
            <Tag type="dot" v-if="props.status=='发起上线'" color="#FF3333">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status=='上线确认'" color="#EE82EE">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status=='预发布完成'" color="#FFBB00">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status.indexOf('预发布中')>=0" color="#FFBB00">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status=='预发验证完'" color="#2db7f5">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status=='上线完成'" color="primary">{{props.status}}</Tag>
            <Tag type="dot" v-if="props.status=='验收完成'" color="success">{{props.status}}</Tag>
          </template>

        </Table>
        <div style="margin: 10px;overflow: hidden">
          <div style="float: right;">
            <Page :total="total" :current.sync="current" @on-change="changePage"></Page>
          </div>
        </div>

      </Card>
    </Row>

  </div>
</template>


<script>

  import {getOnlineOrderList} from '@/api/onlineorder'
  import {formatDateYYYMMDD} from '@/lib/tools'
  import {mapState, mapGetters, mapActions} from 'vuex'

  export default {
    data() {
      return {
        table_header: [
          {
            title: 'ID',
            key: 'id',
            maxWidth: 60
          },
          {
            title: '团队',
            key: 'dev_team',
            maxWidth: 150,
            render: (h, params) => {
              return h(
                'div',
                this.$refs.myTable.$scopedSlots.dev_team_render({dev_team: JSON.parse(params.row.dev_team)})
              )
            }
          },
          {
            title: '标题',
            key: 'title',
            render: (h, params) => {
              return h(
                'div',
                this.$refs.myTable.$scopedSlots.title_render({
                  title: params.row.title,
                  id: params.row.id,
                  system: params.row.system,
                })
              )
            }
          },
          {
            title: '相关人员',
            key: 'dev_users',
            maxWidth: 200,
            render: (h, params) => {
              return h(
                'div',
                this.$refs.myTable.$scopedSlots.users_render({
                  users: JSON.parse(params.row.users),
                  dev_users: JSON.parse(params.row.dev_users),
                  test_users: JSON.parse(params.row.test_users),
                  product_users: JSON.parse(params.row.product_users),
                })
              )
            }
          },
          {
            title: '上线日期',
            key: 'real_online_time',
            maxWidth: 155
          },
          {
            title: '当前状态',
            key: 'status',
            maxWidth: 180,
            render: (h, params) => {
              return h(
                'div',
                this.$refs.myTable.$scopedSlots.status_render({status: params.row.status})
              )
            }
          }
        ],
        table_content: [],
        formItem: {},
        search_data: {
          dev_team__icontains: '',
          status: '',
          real_online_time: '',
          system: '',
          type: '',
        },
        search_query: {
          offset: 0
        },
        total: 0,
        current: 1

      }
    },
    computed: {
      ...mapGetters([
        'realname',
      ]),
    },
    methods: {
      changePage(page) {
        this.search_query.offset = (page - 1) * 10
        this.search_change('from_page')
      },

      search_change_real_submit_test_time(val, type) {
        this.search_data.real_submit_test_time = val
        this.search_change()
      },
      search_change_real_online_time(val, type) {
        this.search_data.real_online_time = val
        this.search_change()
      },
      getOnlineOrderList({data, query}) {
        data = {
          "dev_users__icontains": "\"" + this.realname + "\"",
          "test_users__icontains": "\"" + this.realname + "\"",
          "product_users__icontains": "\"" + this.realname + "\"",
          "users__icontains": "\"" + this.realname + "\"",
          "type": "Q"
        }
        getOnlineOrderList({data, query}).then(res => {
          if (res.data.status) {
            this.table_content = res.data.data
            this.total = res.data.count
          } else {

          }
        });
      },
      search_change(val) {

        if (val != 'from_page') {
          this.search_query.offset = 0
          this.current = 1
        }


        let data = {...this.search_data}
        for (let i in data) {
          if (data[i] == '' || JSON.stringify(data[i]) == '["",""]') {
            delete data[i]
          }


        }
        let query = this.search_query


        this.getOnlineOrderList({data, query})
      }
    },
    mounted: function () {
      this.getOnlineOrderList({})
    }
  }
</script>

